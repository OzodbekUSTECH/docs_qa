<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Management</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --accent-muted: rgba(56, 189, 248, 0.15);
            --purple: #a855f7;
            --text: #e2e8f0;
            --subtle: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-button {
            padding: 8px 16px;
            background: rgba(56, 189, 248, 0.15);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 8px;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-button:hover {
            background: rgba(56, 189, 248, 0.25);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .container {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(350px, 0.35fr);
            gap: 24px;
            padding: 24px;
            flex: 1;
            overflow: hidden;
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        }

        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .search-bar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .search-bar input {
            width: 100%;
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 0.96rem;
            font-family: inherit;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--subtle);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: rgba(15, 23, 42, 0.3);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-processing {
            background: rgba(56, 189, 248, 0.15);
            color: var(--accent);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        button {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        button.btn-info {
            background: rgba(56, 189, 248, 0.15);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        button.btn-info:hover:not(:disabled) {
            background: rgba(56, 189, 248, 0.25);
            border-color: var(--accent);
        }

        button.btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        button.btn-danger:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.25);
            border-color: var(--error);
        }

        button.btn-secondary {
            background: rgba(148, 163, 184, 0.15);
            color: var(--subtle);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        button.btn-secondary:hover:not(:disabled) {
            background: rgba(148, 163, 184, 0.25);
            border-color: var(--subtle);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .pagination {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.65);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(15, 23, 42, 0.85);
            border-color: var(--accent);
        }

        .pagination button.active {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        .pagination-info {
            margin: 0 12px;
            color: var(--subtle);
            font-size: 0.85rem;
        }

        .upload-panel {
            display: flex;
            flex-direction: column;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        }

        .upload-area {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            border-radius: 12px;
            margin: 24px;
            background: rgba(15, 23, 42, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 300px;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(15, 23, 42, 0.5);
        }

        .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 8px;
            text-align: center;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--subtle);
            text-align: center;
        }

        .upload-form {
            padding: 24px;
            border-top: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--subtle);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group select {
            width: 100%;
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 0.96rem;
            font-family: inherit;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .extraction-fields-container {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.3);
        }

        .extraction-fields-container.empty {
            display: none;
        }

        .extraction-field-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .extraction-field-item:hover {
            background: rgba(15, 23, 42, 0.7);
        }

        .extraction-field-item input[type="checkbox"] {
            margin-top: 4px;
            cursor: pointer;
        }

        .extraction-field-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
            font-size: 0.9rem;
        }

        .extraction-field-name {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
        }

        .extraction-field-description {
            font-size: 0.8rem;
            color: var(--subtle);
        }

        .extraction-fields-loading {
            text-align: center;
            padding: 20px;
            color: var(--subtle);
            font-size: 0.85rem;
        }

        button.btn-primary {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent), #6366f1);
            color: var(--bg);
            font-weight: 600;
            box-shadow: 0 12px 20px rgba(56, 189, 248, 0.25);
        }

        button.btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(56, 189, 248, 0.35);
        }

        .file-list {
            padding: 0 24px 24px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .file-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-remove {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .message {
            padding: 12px 24px;
            margin: 0 24px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .message.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--subtle);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--subtle);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--card);
            margin: 0.5% auto;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 98%;
            max-width: 1800px;
            max-height: 98vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .modal-close {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: var(--error);
        }

        .modal-body {
            padding: 0;
            overflow: hidden;
            flex: 1;
            color: var(--text);
            display: flex;
            flex-direction: row;
            min-height: 0;
        }

        .modal-left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            overflow: hidden;
            padding: 24px;
            background: rgba(15, 23, 42, 0.35);
        }

        .modal-right-panel {
            width: 420px;
            min-width: 360px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.2);
        }

        .document-viewer {
            flex: 1;
            position: relative;
            overflow: auto;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(56, 189, 248, 0.1);
        }

        .document-viewer.single-image {
            align-items: center;
        }

        .document-pages {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 32px;
            padding-right: 12px;
        }

        .pdf-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .pdf-page-label {
            font-size: 0.85rem;
            color: var(--subtle);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .document-viewer-content {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: inline-block;
        }

        .document-viewer-content.pdf-viewer {
            width: 100%;
        }

        .document-viewer-content canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.45);
            background: #0f172a;
        }

        .document-viewer img,
        .document-viewer iframe {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.45);
        }

        .document-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .document-viewer-content img {
            position: relative;
            z-index: 1;
        }

        .bbox-highlight {
            position: absolute;
            border: 2px solid var(--accent);
            background: rgba(56, 189, 248, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: auto;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3), 0 6px 18px rgba(14, 165, 233, 0.25);
        }

        .bbox-highlight:hover {
            background: rgba(56, 189, 248, 0.35);
            border-color: #0ea5e9;
            z-index: 10;
        }

        .bbox-highlight.active {
            background: rgba(168, 85, 247, 0.3);
            border-color: var(--purple);
            z-index: 20;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.35), 0 10px 24px rgba(168, 85, 247, 0.25);
        }

        .document-info-panel {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .document-info-panel h4 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            color: var(--accent);
        }

        .extracted-fields-panel {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .extracted-fields-panel h4 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            color: var(--accent);
        }

        .field-value-item {
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .field-value-item:hover {
            border-color: var(--accent);
            background: rgba(15, 23, 42, 0.5);
        }

        .field-value-item.active {
            border-color: var(--purple);
            background: rgba(168, 85, 247, 0.15);
        }

        .field-value-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .field-value-toggle {
            font-size: 0.7rem;
            color: var(--subtle);
            transition: transform 0.2s ease;
            margin-right: 8px;
        }

        .field-value-item.expanded .field-value-toggle {
            transform: rotate(90deg);
        }

        .field-value-content {
            display: none;
            margin-top: 8px;
        }

        .field-value-item.expanded .field-value-content {
            display: block;
        }

        .field-value-name {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .field-value-confidence {
            font-size: 0.75rem;
            color: var(--subtle);
            padding: 2px 8px;
            background: rgba(56, 189, 248, 0.15);
            border-radius: 999px;
        }

        .field-value-text {
            color: var(--text);
            font-size: 0.85rem;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .field-value-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--subtle);
        }

        .field-value-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .page-selector {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(15, 23, 42, 0.3);
        }

        .page-selector label {
            font-size: 0.85rem;
            color: var(--subtle);
        }

        .page-selector select {
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text);
            font-size: 0.85rem;
            font-family: inherit;
        }

        .page-selector select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .document-info {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .document-info-item {
            margin-bottom: 8px;
        }

        .document-info-item strong {
            color: var(--accent);
            margin-right: 8px;
        }

        .document-content {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 8px;
            padding: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }

        .document-content.markdown {
            white-space: normal;
            font-family: inherit;
        }

        .document-content.markdown h1 {
            font-size: 1.5rem;
            margin: 1.5em 0 0.5em 0;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5em;
        }

        .document-content.markdown h2 {
            font-size: 1.3rem;
            margin: 1.3em 0 0.5em 0;
            color: var(--accent);
        }

        .document-content.markdown h3 {
            font-size: 1.1rem;
            margin: 1.1em 0 0.5em 0;
            color: var(--text);
        }

        .document-content.markdown code {
            background: rgba(15, 23, 42, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--accent);
        }

        .document-content.markdown pre {
            background: rgba(15, 23, 42, 0.7);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid var(--border);
        }

        .document-content.markdown pre code {
            background: transparent;
            padding: 0;
            color: var(--text);
        }

        .document-content.markdown strong {
            color: var(--text);
            font-weight: 600;
        }

        .document-content.markdown em {
            color: var(--subtle);
            font-style: italic;
        }

        .document-content.markdown ul,
        .document-content.markdown ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .document-content.markdown li {
            margin: 4px 0;
        }

        .document-content.markdown p {
            margin: 8px 0;
        }

        .document-content.markdown table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .document-content.markdown table th,
        .document-content.markdown table td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
        }

        .document-content.markdown table th {
            background: rgba(15, 23, 42, 0.5);
            font-weight: 600;
        }

        .document-content::-webkit-scrollbar {
            width: 8px;
        }

        .document-content::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 4px;
        }

        .document-content::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .document-content::-webkit-scrollbar-thumb:hover {
            background: #0ea5e9;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Document Management</h1>
            <a href="/extraction-fields" class="nav-button">üîç Extraction Fields</a>
            <a href="/chat" class="nav-button">üí¨ Chat</a>
        </div>
    </div>

    <div class="container">
        <div class="main-panel">
            <div class="panel-header">
                <h2>Documents List</h2>
            </div>
            <div id="message"></div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search by filename..." onkeyup="handleSearch()">
            </div>
            <div class="table-container">
                <div id="loading" class="loading">Loading...</div>
                <table id="documentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <div class="upload-panel">
            <div class="panel-header">
                <h2>Upload Documents</h2>
            </div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Drag files here</div>
                <div class="upload-hint">or click to select</div>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx" style="display: none;">
            </div>
            <div class="file-list" id="fileList" style="display: none;"></div>
            <div class="upload-form">
                <div class="form-group">
                    <label for="typeSelect">Document Type</label>
                    <select id="typeSelect" onchange="handleDocumentTypeChange()">
                        <option value="">-- Select type --</option>
                        <option value="FINANCIAL">FINANCIAL</option>
                        <option value="INVOICE">INVOICE</option>
                        <option value="CONTRACT">CONTRACT</option>
                        <option value="COO">COO</option>
                        <option value="COA">COA</option>
                        <option value="COW">COW</option>
                        <option value="COQ">COQ</option>
                        <option value="BL">BL</option>
                        <option value="LC">LC</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Extraction Fields</label>
                    <div id="extractionFieldsContainer" class="extraction-fields-container empty">
                        <div class="extraction-fields-loading">Select document type</div>
                    </div>
                </div>
                <button class="btn-primary" id="uploadBtn" onclick="handleUpload()">Upload</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div id="contentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">View Document</h3>
                <button class="modal-close" onclick="closeContentModal()">‚úï Close</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Rerun Extraction -->
    <div id="rerunExtractionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Rerun Extraction</h3>
                <button class="modal-close" onclick="closeRerunExtractionModal()">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div id="rerunExtractionMessage"></div>
                <div class="form-group">
                    <label>Select Extraction Fields</label>
                    <div id="rerunExtractionFieldsContainer" class="extraction-fields-container">
                        <div class="extraction-fields-loading">Loading fields...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-secondary" onclick="closeRerunExtractionModal()">Cancel</button>
                <button class="btn-primary" id="rerunExtractionBtn" onclick="handleRerunExtraction()">Rerun Extraction</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Update Document -->
    <div id="updateDocumentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Update Document</h3>
                <button class="modal-close" onclick="closeUpdateDocumentModal()">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div id="updateDocumentMessage"></div>
                <div class="form-group">
                    <label for="updateTypeSelect">Document Type</label>
                    <select id="updateTypeSelect">
                        <option value="">-- Select type --</option>
                        <option value="FINANCIAL">FINANCIAL</option>
                        <option value="INVOICE">INVOICE</option>
                        <option value="CONTRACT">CONTRACT</option>
                        <option value="COO">COO</option>
                        <option value="COA">COA</option>
                        <option value="COW">COW</option>
                        <option value="COQ">COQ</option>
                        <option value="BL">BL</option>
                        <option value="LC">LC</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-secondary" onclick="closeUpdateDocumentModal()">Cancel</button>
                <button class="btn-primary" id="updateDocumentBtn" onclick="handleUpdateDocument()">Update</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/documents';
        const EXTRACTION_FIELDS_API = '/extraction-fields';
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let searchTimeout;
        let selectedFiles = [];
        let availableExtractionFields = [];
        let selectedExtractionFieldIds = [];
        
        // Variables for rerun extraction and update modals
        let currentRerunDocumentId = null;
        let currentRerunDocumentType = null;
        let rerunSelectedFieldIds = [];
        let currentUpdateDocumentId = null;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        let currentDocument = null;
        let isPdfDocument = false;
        let currentDocumentUrl = null;
        let pdfDocumentInstance = null;
        let pdfJsLoadingPromise = null;
        const pdfPageMetrics = new Map();

        function loadPdfJs() {
            if (window.pdfjsLib) {
                return Promise.resolve(window.pdfjsLib);
            }
            if (pdfJsLoadingPromise) {
                return pdfJsLoadingPromise;
            }

            pdfJsLoadingPromise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.crossOrigin = 'anonymous';
                script.referrerPolicy = 'no-referrer';
                script.onload = () => {
                    if (window.pdfjsLib) {
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        resolve(window.pdfjsLib);
                    } else {
                        reject(new Error('pdfjsLib unavailable after loading script'));
                    }
                };
                script.onerror = () => {
                    pdfJsLoadingPromise = null;
                    reject(new Error('Failed to load pdf.js library'));
                };
                document.head.appendChild(script);
            });

            return pdfJsLoadingPromise;
        }

        function normalizeFileUrl(filePath) {
            if (!filePath) {
                return '';
            }
            let url = filePath.replace(/\\/g, '/');
            if (url.startsWith('storage/')) {
                url = url.substring(8);
            }
            if (!url.startsWith('/') && !url.startsWith('http')) {
                url = `/storage/${url}`;
            } else if (url.startsWith('/storage/')) {
                // already ok
            } else if (!url.startsWith('http')) {
                url = `/storage${url}`;
            }
            return url;
        }

        function isPdfFile(filename) {
            if (!filename) return false;
            return filename.toLowerCase().endsWith('.pdf');
        }

        async function ensurePdfDocument(fileUrl) {
            await loadPdfJs(); // Ensure pdf.js is loaded
            if (!pdfDocumentInstance || currentDocumentUrl !== fileUrl) {
                try {
                    pdfDocumentInstance = await window.pdfjsLib.getDocument(fileUrl).promise;
                    currentDocumentUrl = fileUrl;
                } catch (error) {
                    console.error('Failed to load PDF document:', error);
                    pdfDocumentInstance = null;
                    return null;
                }
            }
            return pdfDocumentInstance;
        }

        async function renderPdfDocument(documentData) {
            const pagesContainer = document.getElementById('documentPages');
            if (!pagesContainer) return;

            const fileUrl = normalizeFileUrl(documentData.file_path);
            if (!fileUrl) {
                console.error('Failed to determine file path for PDF viewing.');
                return;
            }

            const pdfDoc = await ensurePdfDocument(fileUrl);
            if (!pdfDoc) {
                return;
            }

            pdfPageMetrics.clear();
            pagesContainer.innerHTML = '';

            const availableWidth = pagesContainer.clientWidth || pagesContainer.offsetWidth || 900;

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const baseViewport = page.getViewport({ scale: 1 });
                const scale = Math.min(2.5, Math.max(0.6, availableWidth / baseViewport.width));
                const viewport = page.getViewport({ scale });

                const pageContainer = document.createElement('div');
                pageContainer.className = 'pdf-page';
                pageContainer.setAttribute('data-page', pageNum);

                const pageLabel = document.createElement('div');
                pageLabel.className = 'pdf-page-label';
                pageLabel.textContent = `Page ${pageNum}`;

                const content = document.createElement('div');
                content.className = 'document-viewer-content pdf-viewer';

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const overlay = document.createElement('div');
                overlay.className = 'document-overlay';
                overlay.setAttribute('data-page', pageNum);
                overlay.style.width = `${viewport.width}px`;
                overlay.style.height = `${viewport.height}px`;

                content.appendChild(canvas);
                content.appendChild(overlay);
                pageContainer.appendChild(pageLabel);
                pageContainer.appendChild(content);
                pagesContainer.appendChild(pageContainer);

                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;

                pdfPageMetrics.set(pageNum, {
                    originalWidth: baseViewport.width,
                    originalHeight: baseViewport.height,
                    canvasWidth: viewport.width,
                    canvasHeight: viewport.height,
                    overlay,
                });
            }

            renderPdfHighlights(documentData);
        }

        function computeBoundingRect(bbox, metrics) {
            if (!bbox || bbox.length < 4 || !metrics) return null;
            const values = bbox.map(Number);
            if (values.some(v => !Number.isFinite(v))) return null;

            const [a, b, c, d] = values;
            const { originalWidth, originalHeight, canvasWidth, canvasHeight } = metrics;
            const candidates = [];
            const margin = 4;

            const normalized = values.every(v => Math.abs(v) <= 1.5 && Math.abs(v) >= 0);

            function addCandidate(left, top, width, height) {
                if (!Number.isFinite(left) || !Number.isFinite(top) || !Number.isFinite(width) || !Number.isFinite(height)) {
                    return;
                }
                const rect = {
                    left,
                    top,
                    width,
                    height,
                };
                const fitsHorizontally = left >= -margin && left + width <= canvasWidth + margin;
                const fitsVertically = top >= -margin && top + height <= canvasHeight + margin;
                if (width >= 2 && height >= 2 && fitsHorizontally && fitsVertically) {
                    candidates.push(rect);
                }
            }

            function clampRect(rect) {
                if (!rect) return null;
                let { left, top, width, height } = rect;
                left = Math.max(0, Math.min(left, canvasWidth - 2));
                top = Math.max(0, Math.min(top, canvasHeight - 2));
                width = Math.min(width, canvasWidth - left);
                height = Math.min(height, canvasHeight - top);
                if (width < 2 || height < 2) return null;
                return { left, top, width, height };
            }

            function addNormalizedX1Y1X2Y2() {
                const widthNorm = c - a;
                const heightNorm = d - b;
                if (widthNorm > 0 && heightNorm > 0) {
                    addCandidate(a * canvasWidth, b * canvasHeight, widthNorm * canvasWidth, heightNorm * canvasHeight);
                    const topNorm = 1 - d;
                    addCandidate(a * canvasWidth, topNorm * canvasHeight, widthNorm * canvasWidth, heightNorm * canvasHeight);
                }
            }

            function addNormalizedXYWH() {
                if (c > 0 && d > 0) {
                    addCandidate(a * canvasWidth, b * canvasHeight, c * canvasWidth, d * canvasHeight);
                    const topNorm = 1 - (b + d);
                    addCandidate(a * canvasWidth, topNorm * canvasHeight, c * canvasWidth, d * canvasHeight);
                }
            }

            function addAbsoluteX1Y1X2Y2() {
                const widthAbs = c - a;
                const heightAbs = d - b;
                if (widthAbs > 0 && heightAbs > 0) {
                    addCandidate((a / originalWidth) * canvasWidth, (b / originalHeight) * canvasHeight, (widthAbs / originalWidth) * canvasWidth, (heightAbs / originalHeight) * canvasHeight);
                    const topPx = originalHeight - d;
                    addCandidate((a / originalWidth) * canvasWidth, (topPx / originalHeight) * canvasHeight, (widthAbs / originalWidth) * canvasWidth, (heightAbs / originalHeight) * canvasHeight);
                }
            }

            function addAbsoluteXYWH() {
                if (c > 0 && d > 0) {
                    addCandidate((a / originalWidth) * canvasWidth, (b / originalHeight) * canvasHeight, (c / originalWidth) * canvasWidth, (d / originalHeight) * canvasHeight);
                    const topPx = originalHeight - (b + d);
                    addCandidate((a / originalWidth) * canvasWidth, (topPx / originalHeight) * canvasHeight, (c / originalWidth) * canvasWidth, (d / originalHeight) * canvasHeight);
                }
            }

            if (normalized) {
                addNormalizedX1Y1X2Y2();
                addNormalizedXYWH();
            } else {
                addAbsoluteX1Y1X2Y2();
                addAbsoluteXYWH();
            }

            if (candidates.length === 0) {
                const fallback = normalized
                    ? {
                        left: Math.max(0, Math.min(a * canvasWidth, canvasWidth - 10)),
                        top: Math.max(0, Math.min((1 - (b + (d > 1 ? 0 : d))) * canvasHeight, canvasHeight - 10)),
                        width: Math.max(6, Math.min((c > 1 ? c : 0.1) * canvasWidth, canvasWidth)),
                        height: Math.max(6, Math.min((d > 1 ? d : 0.1) * canvasHeight, canvasHeight)),
                    }
                    : {
                        left: Math.max(0, Math.min((a / originalWidth) * canvasWidth, canvasWidth - 10)),
                        top: Math.max(0, Math.min(((originalHeight - (b + d)) / originalHeight) * canvasHeight, canvasHeight - 10)),
                        width: Math.max(6, Math.min(((c > originalWidth ? c : c + 10) / originalWidth) * canvasWidth, canvasWidth)),
                        height: Math.max(6, Math.min(((d > originalHeight ? d : d + 10) / originalHeight) * canvasHeight, canvasHeight)),
                    };
                return clampRect(fallback);
            }

            return clampRect(candidates[0]);
        }

        function renderPdfHighlights(documentData) {
            pdfPageMetrics.forEach(({ overlay }) => {
                overlay.innerHTML = '';
            });

            if (!documentData.field_values) return;

            documentData.field_values.forEach((fv, index) => {
                const pageNum = fv.page_num || 1;
                const metrics = pdfPageMetrics.get(pageNum);
                if (!metrics) return;

                const rect = computeBoundingRect(fv.bbox, metrics);
                if (!rect) return;

                const highlight = document.createElement('div');
                highlight.className = 'bbox-highlight';
                highlight.style.left = `${rect.left}px`;
                highlight.style.top = `${rect.top}px`;
                highlight.style.width = `${rect.width}px`;
                highlight.style.height = `${rect.height}px`;
                highlight.setAttribute('data-field-index', index);
                highlight.onclick = (e) => {
                    e.stopPropagation();
                    highlightField(index);
                };

                metrics.overlay.appendChild(highlight);
            });

            applyActiveHighlightState();
        }

        function renderImageHighlights(documentData) {
            const overlay = document.getElementById('documentOverlay');
            const image = document.getElementById('documentImage');
            if (!overlay || !image || !documentData.field_values) return;

            const imgRect = image.getBoundingClientRect();
            const metrics = {
                originalWidth: image.naturalWidth,
                originalHeight: image.naturalHeight,
                canvasWidth: imgRect.width,
                canvasHeight: imgRect.height,
                overlay,
            };

            overlay.style.width = `${metrics.canvasWidth}px`;
            overlay.style.height = `${metrics.canvasHeight}px`;
            overlay.innerHTML = '';

            documentData.field_values.forEach((fv, index) => {
                const rect = computeBoundingRect(fv.bbox, metrics);
                if (!rect) return;

                const highlight = document.createElement('div');
                highlight.className = 'bbox-highlight';
                highlight.style.left = `${rect.left}px`;
                highlight.style.top = `${rect.top}px`;
                highlight.style.width = `${rect.width}px`;
                highlight.style.height = `${rect.height}px`;
                highlight.setAttribute('data-field-index', index);
                highlight.onclick = (e) => {
                    e.stopPropagation();
                    highlightField(index);
                };

                overlay.appendChild(highlight);
            });

            applyActiveHighlightState();
        }

        function applyActiveHighlightState() {
            const activeItem = document.querySelector('.field-value-item.active');
            if (!activeItem) return;
            const activeIndex = parseInt(activeItem.getAttribute('data-field-index'), 10);
            if (Number.isNaN(activeIndex)) return;

            const activeHighlight = document.querySelector(`.bbox-highlight[data-field-index="${activeIndex}"]`);
            if (activeHighlight) {
                activeHighlight.classList.add('active');
            }
        }

        function attachViewerResizeHandler(handler) {
            if (window.documentViewerResizeHandler) {
                window.removeEventListener('resize', window.documentViewerResizeHandler);
            }
            window.documentViewerResizeHandler = handler;
            if (handler) {
                window.addEventListener('resize', handler);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileSelect(files);
        });
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileSelect(files);
        });

        function handleFileSelect(files) {
            const validFiles = files.filter(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                return ['pdf', 'doc', 'docx'].includes(ext);
            });

            if (validFiles.length === 0) {
                showMessage('Only PDF, DOC, DOCX files are supported', 'error');
                return;
            }

            selectedFiles = [...selectedFiles, ...validFiles];
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileList.innerHTML = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <span class="file-item-name">${file.name}</span>
                    <button class="file-item-remove" onclick="removeFile(${idx})">‚úï</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        async function loadDocuments(page = 1, filename = '') {
            clearAutoRefresh();
            try {
                console.log('loadDocuments called with page=', page, 'filename=', filename);
                console.log('API_BASE=', API_BASE);
                
                document.getElementById('loading').style.display = 'block';
                document.getElementById('documentsTable').style.display = 'none';

                const params = new URLSearchParams({
                    page: page.toString(),
                    size: pageSize.toString()
                });

                if (filename) {
                    params.append('filename', filename);
                }

                const url = `${API_BASE}/?${params}`;
                console.log('Fetching URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                console.log('Documents loaded:', data);
                
                currentPage = data.page;
                totalPages = data.pages;
                
                if (!data.items || data.items.length === 0) {
                    console.log('No documents found');
                }
                
                renderTable(data.items);
                renderPagination();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('documentsTable').style.display = 'table';

                const hasActiveDocuments = Array.isArray(data.items) && data.items.some(doc =>
                    ['PROCESSING', 'PENDING'].includes((doc.status || '').toUpperCase())
                );
                scheduleAutoRefresh(hasActiveDocuments);
            } catch (error) {
                console.error('Error in loadDocuments:', error);
                console.error('Error stack:', error.stack);
                showMessage('Error loading documents: ' + error.message, 'error');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('documentsTable').style.display = 'table';
                document.getElementById('documentsTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--subtle);">Failed to load documents</td></tr>';
                scheduleAutoRefresh(false);
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable(documents) {
            const tbody = document.getElementById('documentsTableBody');
            tbody.innerHTML = '';

            if (documents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--subtle);">No documents found</td></tr>';
                return;
            }

            documents.forEach(doc => {
                const row = document.createElement('tr');
                const statusClass = `status-${doc.status.toLowerCase()}`;
                const createdAt = new Date(doc.created_at).toLocaleString('en-US');

                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${doc.filename}</td>
                    <td>${doc.type}</td>
                    <td><span class="status-badge ${statusClass}">${doc.status}</span></td>
                    <td>${createdAt}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-info" onclick="viewDocument(${doc.id})">View</button>
                            <button class="btn-info" onclick="openRerunExtractionModal(${doc.id})">Rerun Extraction</button>
                            <button class="btn-info" onclick="openUpdateDocumentModal(${doc.id})">Update</button>
                            <button class="btn-danger" onclick="deleteDocument(${doc.id})">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => loadDocuments(currentPage - 1, document.getElementById('searchInput').value);
            pagination.appendChild(prevBtn);

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.onclick = () => loadDocuments(1, document.getElementById('searchInput').value);
                pagination.appendChild(firstBtn);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-info';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => loadDocuments(i, document.getElementById('searchInput').value);
                pagination.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-info';
                    pagination.appendChild(ellipsis);
                }
                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => loadDocuments(totalPages, document.getElementById('searchInput').value);
                pagination.appendChild(lastBtn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => loadDocuments(currentPage + 1, document.getElementById('searchInput').value);
            pagination.appendChild(nextBtn);

            const info = document.createElement('span');
            info.className = 'pagination-info';
            info.textContent = `Page ${currentPage} of ${totalPages}`;
            pagination.appendChild(info);
        }

        // –ü–æ–∏—Å–∫
        function handleSearch() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('searchInput').value;
            searchTimeout = setTimeout(() => {
                loadDocuments(1, query);
            }, 500);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ extraction fields –ø–æ document type
        async function loadExtractionFields(documentType) {
            const container = document.getElementById('extractionFieldsContainer');
            
            if (!documentType) {
                container.classList.add('empty');
                container.innerHTML = '<div class="extraction-fields-loading">Select document type</div>';
                availableExtractionFields = [];
                selectedExtractionFieldIds = [];
                return;
            }

            container.classList.remove('empty');
            container.innerHTML = '<div class="extraction-fields-loading">Loading fields...</div>';

            try {
                const params = new URLSearchParams({
                    page: '1',
                    size: '100'
                });
                params.append('document_types', documentType);

                const response = await fetch(`${EXTRACTION_FIELDS_API}/?${params}`);
                
                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                availableExtractionFields = data.items || [];
                renderExtractionFields(availableExtractionFields);
            } catch (error) {
                console.error('Error loading extraction fields:', error);
                container.innerHTML = `<div class="extraction-fields-loading" style="color: var(--error);">Loading error: ${escapeHtml(error.message)}</div>`;
                availableExtractionFields = [];
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ extraction fields
        function renderExtractionFields(fields) {
            const container = document.getElementById('extractionFieldsContainer');
            
            if (fields.length === 0) {
                container.innerHTML = '<div class="extraction-fields-loading">No available fields for this document type</div>';
                return;
            }

            container.innerHTML = fields.map(field => `
                <div class="extraction-field-item">
                    <input 
                        type="checkbox" 
                        id="field_${field.id}" 
                        value="${field.id}"
                        onchange="handleExtractionFieldToggle(${field.id})"
                        ${selectedExtractionFieldIds.includes(field.id) ? 'checked' : ''}
                    >
                    <label for="field_${field.id}">
                        <div class="extraction-field-name">${escapeHtml(field.name)}</div>
                        ${field.short_description ? `<div class="extraction-field-description">${escapeHtml(field.short_description)}</div>` : ''}
                    </label>
                </div>
            `).join('');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è document type
        function handleDocumentTypeChange() {
            const typeSelect = document.getElementById('typeSelect');
            const selectedType = typeSelect.value;
            selectedExtractionFieldIds = [];
            loadExtractionFields(selectedType);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è extraction field
        function handleExtractionFieldToggle(fieldId) {
            const checkbox = document.getElementById(`field_${fieldId}`);
            if (checkbox.checked) {
                if (!selectedExtractionFieldIds.includes(fieldId)) {
                    selectedExtractionFieldIds.push(fieldId);
                }
            } else {
                selectedExtractionFieldIds = selectedExtractionFieldIds.filter(id => id !== fieldId);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function handleUpload() {
            if (selectedFiles.length === 0) {
                showMessage('Select files to upload', 'error');
                return;
            }

            const typeSelect = document.getElementById('typeSelect');
            if (!typeSelect.value) {
                showMessage('Select document type', 'error');
                return;
            }

            if (selectedExtractionFieldIds.length === 0) {
                showMessage('Select at least one extraction field', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalButtonText = uploadBtn.textContent;
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            let successCount = 0;
            let errorCount = 0;

            for (const file of selectedFiles) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('type', typeSelect.value);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π extraction_field_id –æ—Ç–¥–µ–ª—å–Ω–æ
                    selectedExtractionFieldIds.forEach(id => {
                        formData.append('extraction_field_ids', id.toString());
                    });

                    const response = await fetch(API_BASE + '/', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorMessage = await parseErrorResponse(response);
                        throw new Error(errorMessage);
                    }

                    successCount++;
                } catch (error) {
                    errorCount++;
                    console.error('Error uploading file:', file.name, error);
                }
            }

            if (successCount > 0) {
                showMessage(`Successfully uploaded: ${successCount}${errorCount > 0 ? `, errors: ${errorCount}` : ''}`, 'success');
                selectedFiles = [];
                renderFileList();
                fileInput.value = '';
                loadDocuments(currentPage, document.getElementById('searchInput').value);
            } else {
                showMessage(`Error uploading all files: ${errorCount}`, 'error');
            }

            uploadBtn.disabled = false;
            uploadBtn.textContent = originalButtonText;
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function viewDocument(id) {
            const modal = document.getElementById('contentModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/${id}`);
                
                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }

                const doc = await response.json();
                currentDocument = doc;
                isPdfDocument = isPdfFile(doc.filename);
                currentDocumentUrl = normalizeFileUrl(doc.file_path);
                pdfDocumentInstance = null;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ layout
                const leftPanel = createDocumentViewer(doc);
                const rightPanel = createDocumentInfoPanel(doc);
                
                modalBody.innerHTML = `
                    <div class="modal-left-panel">
                        ${leftPanel}
                    </div>
                    <div class="modal-right-panel">
                        ${rightPanel}
                    </div>
                `;
                
                modalTitle.textContent = `View: ${doc.filename}`;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                setTimeout(async () => {
                    await initializeDocumentViewer(doc);
                }, 100);
            } catch (error) {
                modalBody.innerHTML = `
                    <div class="message error" style="margin: 20px;">
                        Loading error: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        function createDocumentViewer(doc) {
            const fileUrl = normalizeFileUrl(doc.file_path);
            const isPdf = isPdfFile(doc.filename);
            
            if (isPdf) {
                return `
                    <div class="document-viewer">
                        <div class="document-pages" id="documentPages"></div>
                    </div>
                `;
            }
            
            return `
                <div class="document-viewer single-image">
                    <div class="document-viewer-content" id="documentViewerContent">
                        <img src="${fileUrl}" id="documentImage" alt="Document" style="display: block; max-width: 100%; height: auto;">
                        <div class="document-overlay" id="documentOverlay"></div>
                    </div>
                </div>
            `;
        }

        function createDocumentInfoPanel(doc) {
            const infoHtml = `
                <div class="document-info-panel">
                    <h4>Document Information</h4>
                    <div class="document-info">
                        <div class="document-info-item"><strong>ID:</strong> ${doc.id}</div>
                        <div class="document-info-item"><strong>Filename:</strong> ${escapeHtml(doc.filename)}</div>
                        <div class="document-info-item"><strong>Type:</strong> ${doc.type}</div>
                        <div class="document-info-item"><strong>Status:</strong> <span class="status-badge status-${doc.status.toLowerCase()}">${doc.status}</span></div>
                        <div class="document-info-item"><strong>Created:</strong> ${new Date(doc.created_at).toLocaleString('en-US')}</div>
                    </div>
                </div>
            `;

            const fieldsCount = doc.field_values?.length || 0;
            const fieldsHtml = `
                <div class="extracted-fields-panel">
                    <h4>Extracted Fields (${fieldsCount})</h4>
                    ${doc.field_values && doc.field_values.length > 0 ? 
                        doc.field_values.map((fv, index) => `
                            <div class="field-value-item" data-field-index="${index}" data-page="${fv.page_num || ''}" onclick="toggleFieldValue(${index}, event)">
                                <div class="field-value-header">
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <span class="field-value-toggle">‚ñ∂</span>
                                        <div class="field-value-name">${escapeHtml(fv.field.name)}</div>
                                    </div>
                                    ${fv.confidence !== null ? `<div class="field-value-confidence">${Math.round(fv.confidence * 100)}%</div>` : ''}
                                </div>
                                <div class="field-value-content">
                                    <div class="field-value-text">${escapeHtml(fv.value_text || 'Not found')}</div>
                                    <div class="field-value-meta">
                                        ${fv.page_num ? `<div class="field-value-meta-item">üìÑ Page ${fv.page_num}</div>` : ''}
                                        ${fv.bbox ? `<div class="field-value-meta-item">üìç Coordinates</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') :
                        '<div class="empty-state">No fields extracted</div>'
                    }
                </div>
            `;

            return infoHtml + fieldsHtml;
        }

        function toggleFieldValue(index, event) {
            event.stopPropagation();
            const fieldItem = document.querySelector(`.field-value-item[data-field-index="${index}"]`);
            if (fieldItem) {
                const wasExpanded = fieldItem.classList.contains('expanded');
                fieldItem.classList.toggle('expanded');
                
                // If expanding, also highlight the field on the document
                if (!wasExpanded) {
                    highlightField(index);
                }
            }
        }

        function onDocumentImageLoad() {
            if (currentDocument) {
                initializeDocumentViewer(currentDocument);
            }
        }

        async function initializeDocumentViewer(doc) {
            if (!doc) return;

            const image = document.getElementById('documentImage');
            isPdfDocument = isPdfFile(doc.filename);

            if (isPdfDocument) {
                await renderPdfDocument(doc);
                attachViewerResizeHandler(() => {
                    if (currentDocument) {
                        renderPdfDocument(currentDocument);
                    }
                });
            } else if (image) {
                const renderImage = () => renderImageHighlights(doc);

                if (image.complete && image.naturalWidth > 0) {
                    renderImage();
                } else {
                    image.onload = renderImage;
                }

                attachViewerResizeHandler(() => {
                    if (currentDocument) {
                        renderImageHighlights(currentDocument);
                    }
                });
            }

            applyActiveHighlightState();
        }

        async function highlightField(index) {
            if (!currentDocument || !currentDocument.field_values) return;

            const fieldItemData = currentDocument.field_values[index];
            const pageNum = fieldItemData && fieldItemData.page_num ? fieldItemData.page_num : 1;

            if (isPdfDocument) {
                const pageContainer = document.querySelector(`.pdf-page[data-page="${pageNum}"]`);
                if (pageContainer) {
                    pageContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            document.querySelectorAll('.field-value-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.bbox-highlight').forEach(highlight => {
                highlight.classList.remove('active');
            });

            const fieldItem = document.querySelector(`.field-value-item[data-field-index="${index}"]`);
            if (fieldItem) {
                fieldItem.classList.add('active');
                fieldItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            const highlight = document.querySelector(`.bbox-highlight[data-field-index="${index}"]`);
            if (highlight) {
                highlight.classList.add('active');
            }

            applyActiveHighlightState();
        }

        function closeContentModal() {
            const modal = document.getElementById('contentModal');
            modal.style.display = 'none';
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ resize –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            if (window.documentViewerResizeHandler) {
                window.removeEventListener('resize', window.documentViewerResizeHandler);
                window.documentViewerResizeHandler = null;
            }
            currentDocument = null;
            isPdfDocument = false;
            currentDocumentUrl = null;
            pdfDocumentInstance = null;
            pdfPageMetrics.clear();
            const pagesContainer = document.getElementById('documentPages');
            if (pagesContainer) {
                pagesContainer.innerHTML = '';
            }
            const overlay = document.getElementById('documentOverlay');
            if (overlay) {
                overlay.innerHTML = '';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.onclick = function(event) {
            const contentModal = document.getElementById('contentModal');
            const rerunModal = document.getElementById('rerunExtractionModal');
            const updateModal = document.getElementById('updateDocumentModal');
            
            if (event.target === contentModal) {
                closeContentModal();
            }
            if (event.target === rerunModal) {
                closeRerunExtractionModal();
            }
            if (event.target === updateModal) {
                closeUpdateDocumentModal();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Markdown
        function renderMarkdown(text) {
            if (!text) return '';
            // –ü—Ä–æ—Å—Ç–æ–π markdown —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
            let html = escapeHtml(text);
            
            // –ö–æ–¥ –±–ª–æ–∫–∏ (–¥–æ –¥—Ä—É–≥–∏—Ö –∑–∞–º–µ–Ω)
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // –ò–Ω–ª–∞–π–Ω –∫–æ–¥
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø–æ—Å–ª–µ –∫–æ–¥–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // –ö—É—Ä—Å–∏–≤ (–ø–æ—Å–ª–µ –∂–∏—Ä–Ω–æ–≥–æ, –∏–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
            html = html.replace(/\b\*([^*]+?)\*\b/g, '<em>$1</em>');
            html = html.replace(/\b_([^_]+?)_\b/g, '<em>$1</em>');
            
            // –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏
            const lines = html.split('\n');
            let inOrderedList = false;
            let inUnorderedList = false;
            let result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const orderedMatch = line.match(/^(\d+)\.\s+(.*)$/);
                const unorderedMatch = line.match(/^[-*]\s+(.*)$/);
                
                if (orderedMatch) {
                    if (!inOrderedList) {
                        if (inUnorderedList) {
                            result.push('</ul>');
                            inUnorderedList = false;
                        }
                        result.push('<ol>');
                        inOrderedList = true;
                    }
                    result.push(`<li>${orderedMatch[2]}</li>`);
                } else if (unorderedMatch) {
                    if (!inUnorderedList) {
                        if (inOrderedList) {
                            result.push('</ol>');
                            inOrderedList = false;
                        }
                        result.push('<ul>');
                        inUnorderedList = true;
                    }
                    result.push(`<li>${unorderedMatch[1]}</li>`);
                } else {
                    if (inOrderedList) {
                        result.push('</ol>');
                        inOrderedList = false;
                    }
                    if (inUnorderedList) {
                        result.push('</ul>');
                        inUnorderedList = false;
                    }
                    if (line.trim()) {
                        result.push(line);
                    }
                }
            }
            
            if (inOrderedList) result.push('</ol>');
            if (inUnorderedList) result.push('</ul>');
            
            html = result.join('\n');
            
            // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è HTML —Ç–µ–≥–∞–º–∏)
            html = html.split('\n').map(line => {
                line = line.trim();
                if (!line || line.startsWith('<') || line.match(/^<\/[ou]l>$/)) return line;
                return '<p>' + line + '</p>';
            }).join('\n');
            
            return html;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function deleteDocument(id) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            const deleteButtons = document.querySelectorAll(`button[onclick="deleteDocument(${id})"]`);
            deleteButtons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Deleting...';
            });

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }

                showMessage('Document successfully deleted', 'success');
                loadDocuments(currentPage, document.getElementById('searchInput').value);
            } catch (error) {
                showMessage('Error deleting: ' + error.message, 'error');
                deleteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                });
            }
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ API
        async function parseErrorResponse(response) {
            try {
                const errorData = await response.json();
                if (errorData.error) {
                    return errorData.error;
                } else if (errorData.detail) {
                    if (Array.isArray(errorData.detail)) {
                        return errorData.detail.map(d => {
                            const loc = d.loc ? d.loc.join('.') : '';
                            const msg = d.msg || '';
                            return loc ? `${loc}: ${msg}` : (msg || JSON.stringify(d));
                        }).join(', ');
                    }
                    return errorData.detail;
                }
                return `Error ${response.status}: ${response.statusText}`;
            } catch (e) {
                return `Error ${response.status}: ${response.statusText}`;
            }
        }

        // Adaptive auto refresh
        const ACTIVE_REFRESH_INTERVAL = 5000;
        const IDLE_REFRESH_INTERVAL = 30000;
        let autoRefreshTimeout = null;
        let isAutoRefreshEnabled = true;
        let lastRefreshHadActive = false;

        function clearAutoRefresh() {
            if (autoRefreshTimeout) {
                clearTimeout(autoRefreshTimeout);
                autoRefreshTimeout = null;
            }
        }

        function scheduleAutoRefresh(hasActiveDocuments = lastRefreshHadActive) {
            lastRefreshHadActive = !!hasActiveDocuments;

            if (!isAutoRefreshEnabled) {
                return;
            }

            clearAutoRefresh();

            const interval = document.hidden
                ? IDLE_REFRESH_INTERVAL
                : (lastRefreshHadActive ? ACTIVE_REFRESH_INTERVAL : IDLE_REFRESH_INTERVAL);

            autoRefreshTimeout = setTimeout(() => {
                const loading = document.getElementById('loading');
                const isCurrentlyLoading = loading && loading.style.display !== 'none';

                if (!isCurrentlyLoading) {
                    const searchValue = document.getElementById('searchInput').value;
                    loadDocuments(currentPage, searchValue);
                } else {
                    scheduleAutoRefresh(lastRefreshHadActive);
                }
            }, interval + Math.floor(Math.random() * 1500));
        }

        function stopAutoRefresh() {
            clearAutoRefresh();
        }

        function resumeAutoRefresh(hasActiveDocuments = lastRefreshHadActive) {
            if (!isAutoRefreshEnabled) return;
            scheduleAutoRefresh(hasActiveDocuments);
        }

        document.addEventListener('visibilitychange', () => {
            if (!isAutoRefreshEnabled) {
                return;
            }

            if (document.hidden) {
                scheduleAutoRefresh(lastRefreshHadActive);
            } else {
                const searchValue = document.getElementById('searchInput').value;
                loadDocuments(currentPage, searchValue);
            }
        });

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function openUploadModal() {
            stopAutoRefresh();
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ HTML
        }

        // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeUploadModal() {
            resumeAutoRefresh();
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ HTML
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        console.log('Initializing page, calling loadDocuments...');
        try {
            loadDocuments();
        } catch (error) {
            console.error('Error during initialization:', error);
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // Rerun Extraction Modal Functions
        async function openRerunExtractionModal(documentId) {
            currentRerunDocumentId = documentId;
            rerunSelectedFieldIds = [];
            const modal = document.getElementById('rerunExtractionModal');
            const container = document.getElementById('rerunExtractionFieldsContainer');
            const messageDiv = document.getElementById('rerunExtractionMessage');
            
            messageDiv.style.display = 'none';
            modal.style.display = 'block';
            container.innerHTML = '<div class="extraction-fields-loading">Loading document and fields...</div>';
            
            try {
                // Load document to get type and existing field values
                const docResponse = await fetch(`${API_BASE}/${documentId}`);
                if (!docResponse.ok) {
                    throw new Error('Failed to load document');
                }
                const document = await docResponse.json();
                currentRerunDocumentType = document.type;
                
                // Get existing field IDs from document
                const existingFieldIds = document.field_values 
                    ? document.field_values.map(fv => fv.field.id)
                    : [];
                
                // Load available extraction fields for this document type
                const params = new URLSearchParams({
                    page: '1',
                    size: '100'
                });
                params.append('document_types', document.type);
                
                const fieldsResponse = await fetch(`${EXTRACTION_FIELDS_API}/?${params}`);
                if (!fieldsResponse.ok) {
                    throw new Error('Failed to load extraction fields');
                }
                
                const fieldsData = await fieldsResponse.json();
                const availableFields = fieldsData.items || [];
                
                // Pre-select fields that already exist in the document
                rerunSelectedFieldIds = [...existingFieldIds];
                
                // Render fields with pre-selected checkboxes
                renderRerunExtractionFields(availableFields, existingFieldIds);
            } catch (error) {
                container.innerHTML = `<div class="extraction-fields-loading" style="color: var(--error);">Error: ${escapeHtml(error.message)}</div>`;
            }
        }

        function renderRerunExtractionFields(fields, existingFieldIds) {
            const container = document.getElementById('rerunExtractionFieldsContainer');
            
            if (fields.length === 0) {
                container.innerHTML = '<div class="extraction-fields-loading">No available fields for this document type</div>';
                return;
            }
            
            container.innerHTML = fields.map(field => {
                const isChecked = existingFieldIds.includes(field.id);
                return `
                    <div class="extraction-field-item">
                        <input 
                            type="checkbox" 
                            id="rerun_field_${field.id}" 
                            value="${field.id}"
                            onchange="handleRerunFieldToggle(${field.id})"
                            ${isChecked ? 'checked' : ''}
                        >
                        <label for="rerun_field_${field.id}">
                            <div class="extraction-field-name">${escapeHtml(field.name)}</div>
                            ${field.short_description ? `<div class="extraction-field-description">${escapeHtml(field.short_description)}</div>` : ''}
                        </label>
                    </div>
                `;
            }).join('');
        }

        function handleRerunFieldToggle(fieldId) {
            const checkbox = document.getElementById(`rerun_field_${fieldId}`);
            if (checkbox.checked) {
                if (!rerunSelectedFieldIds.includes(fieldId)) {
                    rerunSelectedFieldIds.push(fieldId);
                }
            } else {
                rerunSelectedFieldIds = rerunSelectedFieldIds.filter(id => id !== fieldId);
            }
        }

        async function handleRerunExtraction() {
            if (!currentRerunDocumentId) {
                showRerunMessage('Document ID is missing', 'error');
                return;
            }
            
            if (rerunSelectedFieldIds.length === 0) {
                showRerunMessage('Select at least one extraction field', 'error');
                return;
            }
            
            const btn = document.getElementById('rerunExtractionBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Rerunning...';
            
            try {
                const response = await fetch(`${API_BASE}/${currentRerunDocumentId}/rerun-extraction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        extraction_field_ids: rerunSelectedFieldIds
                    })
                });
                
                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }
                
                showRerunMessage('Extraction rerun started successfully', 'success');
                closeRerunExtractionModal();
                loadDocuments(currentPage, document.getElementById('searchInput').value);
            } catch (error) {
                showRerunMessage('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showRerunMessage(message, type) {
            const messageDiv = document.getElementById('rerunExtractionMessage');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function closeRerunExtractionModal() {
            document.getElementById('rerunExtractionModal').style.display = 'none';
            currentRerunDocumentId = null;
            currentRerunDocumentType = null;
            rerunSelectedFieldIds = [];
        }

        // Update Document Modal Functions
        async function openUpdateDocumentModal(documentId) {
            currentUpdateDocumentId = documentId;
            const modal = document.getElementById('updateDocumentModal');
            const messageDiv = document.getElementById('updateDocumentMessage');
            const typeSelect = document.getElementById('updateTypeSelect');
            
            messageDiv.style.display = 'none';
            modal.style.display = 'block';
            
            try {
                // Load document to get current type
                const response = await fetch(`${API_BASE}/${documentId}`);
                if (!response.ok) {
                    throw new Error('Failed to load document');
                }
                const document = await response.json();
                
                // Set current type in select
                typeSelect.value = document.type || '';
            } catch (error) {
                showUpdateMessage('Error loading document: ' + error.message, 'error');
            }
        }

        async function handleUpdateDocument() {
            if (!currentUpdateDocumentId) {
                showUpdateMessage('Document ID is missing', 'error');
                return;
            }
            
            const typeSelect = document.getElementById('updateTypeSelect');
            const newType = typeSelect.value;
            
            if (!newType) {
                showUpdateMessage('Select document type', 'error');
                return;
            }
            
            const btn = document.getElementById('updateDocumentBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Updating...';
            
            try {
                const response = await fetch(`${API_BASE}/${currentUpdateDocumentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: newType
                    })
                });
                
                if (!response.ok) {
                    const errorMessage = await parseErrorResponse(response);
                    throw new Error(errorMessage);
                }
                
                showUpdateMessage('Document updated successfully', 'success');
                closeUpdateDocumentModal();
                loadDocuments(currentPage, document.getElementById('searchInput').value);
            } catch (error) {
                showUpdateMessage('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showUpdateMessage(message, type) {
            const messageDiv = document.getElementById('updateDocumentMessage');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function closeUpdateDocumentModal() {
            document.getElementById('updateDocumentModal').style.display = 'none';
            currentUpdateDocumentId = null;
        }
    </script>
</body>
</html>
